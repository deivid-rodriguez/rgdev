#!/usr/bin/env ruby

require "open3"

force_run = ARGV.include?("--force")
ARGV.delete("--force")

PRIVILEGED_FLAG_FILE = ENV['HOME'] + ".rgdev-run-privileged"

if File.basename(Dir.pwd) != "rubygems" && !force_run
  $stderr.puts "#{$0}: error: expected to be ran from a directory named \`rubygems'."
  $stderr.puts "Pass --force to attempt anyway."
  exit 1
end

def privileged?
  File.exist?(PRIVILEGED_FLAG_FILE) &&
    (File.read(PRIVILEGED_FLAG_FILE) == "true")
end

def docker(cmd)
  # the --privileged flag helps with permissions issues.
  privileged = ""
  if privileged?
    privileged_str = "--privileged"
  end

  workdir = "/home/developer/rubygems"
  volume  = "#{Dir.pwd}:#{workdir}"
  uid     = "-u #{ENV['UID']}" if ENV['UID']

  exec "docker run #{privileged_str} -h rgdev --rm -it -v #{volume} -w #{workdir} #{uid} duckinator/rubygems-dev #{cmd}"
end

case ARGV[0]
when nil, "-h", "--help"
  puts "Usage:  rgdev [COMMAND]"
when "--make-privileged"
  File.write(PRIVILEGED_FLAG_FILE, "true")
else
  docker(ARGV.join(" "))
end
